<!doctype html>
<html lang="zh-CN">

<head>
    <script src="framework/example/zepto.min.js"></script>

    <!-- 原始地址：//webapi.amap.com/ui/1.0/ui/misc/PositionPicker/examples/positionPicker.html -->
    <base href="//webapi.amap.com/ui/1.0/ui/misc/PositionPicker/examples/" />
    <meta charset="utf-8">
    <meta name="viewport" content="initial-scale=1.0, user-scalable=no, width=device-width">
    <title>拖拽选址</title>
    <!--引入高德地图JSAPI -->
    <script src="//webapi.amap.com/maps?v=1.3&key=777f167eb23f4f88a60548f30ce1a96d"></script>

    <!--引入UI组件库（1.0版本） -->
    <script src="//webapi.amap.com/ui/1.0/main.js"></script>
    <!--异步加载 高德地图JSAPI ，注意 callback 参数-->
    <script src="//webapi.amap.com/maps?v=1.3&key=777f167eb23f4f88a60548f30ce1a96d&radius&plugin=AMap.ToolBar"></script>

    <!--引入UI组件库异步版本main-async.js（1.0版本） -->
    <script src="//webapi.amap.com/ui/1.0/main-async.js"></script>

    <script type="text/javascript">
        //JSAPI回调入口
        function my_init() {
            initAMapUI(); //这里调用initAMapUI初始化
            //其他逻辑
        }
    </script>

    <style>
        html,
        body {
            height: 100%;
            margin: 0;
            width: 100%;
            padding: 0;
            overflow: hidden;
            font-size: 13px;
        }
        
        .map {
            height: 100%;
            width: 60%;
            float: left;
        }
        
        #right {
            color: #444;
            background-color: #f8f8f8;
            width: 40%;
            float: left;
            height: 100%;
        }
        
        #start,
        #stop,
        #right input {
            margin: 4px;
            margin-left: 15px;
        }
        
        .title {
            width: 100%;
            background-color: #dadada
        }
        
        button {
            border: solid 1px;
            margin-left: 15px;
            background-color: #dadafa;
        }
        
        .c {
            font-weight: 600;
            padding-left: 15px;
            padding-top: 4px;
        }
        
        #lnglat,
        #address,
        #nearestJunction,
        #nearestRoad,
        #nearestPOI,
        .title {
            padding-left: 15px;
        }
    </style>
</head>

<body>
    <div id="container" class="map" tabindex="0"></div>
    <div id='right'>
        <div>
            <div class='title'>选择模式</div>
            <input type='radio' name='mode' value='dragMap' checked>拖拽地图模式</input>
            </br>
            <input type='radio' name='mode' value='dragMarker'>拖拽Marker模式</input>
        </div>
        <div>
            <button id='start'>开始选点</button>
            <button id='stop'>关闭选点</button>
        </div>
        <div>
            <div class='title'>选址结果</div>
            <div class='c'>经纬度:</div>
            <div id='lnglat'></div>
            <div class='c'>地址:</div>
            <div id='address'></div>
            <div class='c'>最近的路口:</div>
            <div id='nearestJunction'></div>
            <div class='c'>最近的路:</div>
            <div id='nearestRoad'></div>
            <div class='c'>最近的POI:</div>
            <div id='nearestPOI'></div>
        </div>
    </div>

    <script type="text/javascript">
        var locat, locats, jd, wd;

        function maps(params, params2) {
            AMapUI.loadUI(['misc/PositionPicker'], function(PositionPicker) {
                console.log(params)
                console.log(params2)
                var map = new AMap.Map('container', {
                    zoom: 17,
                    center: [params, params2],
                    resizeEnable: true,
                    scrollWheel: false
                })
                var positionPicker = new PositionPicker({
                    mode: 'dragMap',
                    map: map
                });

                positionPicker.on('success', function(positionResult) {
                    console.log(positionResult)

                    document.getElementById('lnglat').innerHTML = positionResult.position;
                    document.getElementById('address').innerHTML = positionResult.address;
                    document.getElementById('nearestJunction').innerHTML = positionResult.nearestJunction;
                    document.getElementById('nearestRoad').innerHTML = positionResult.nearestRoad;
                    document.getElementById('nearestPOI').innerHTML = positionResult.nearestPOI;
                });
                positionPicker.on('fail', function(positionResult) {
                    console.log(positionResult)
                        // document.getElementById('lnglat').innerHTML = ' ';
                        // document.getElementById('address').innerHTML = ' ';
                        // document.getElementById('nearestJunction').innerHTML = ' ';
                        // document.getElementById('nearestRoad').innerHTML = ' ';
                        // document.getElementById('nearestPOI').innerHTML = ' ';
                });
                // var onModeChange = function(e) {
                //     positionPicker.setMode(e.target.value)
                // }

                // var startButton = document.getElementById('start');
                // var stopButton = document.getElementById('stop');
                // var dragMapMode = document.getElementsByName('mode')[0];
                // var dragMarkerMode = document.getElementsByName('mode')[1];
                // AMap.event.addDomListener(startButton, 'click', function() {
                //     positionPicker.start(map.getBounds().getSouthWest())
                // })
                // AMap.event.addDomListener(stopButton, 'click', function() {
                //     positionPicker.stop();
                // })
                // AMap.event.addDomListener(dragMapMode, 'change', onModeChange)
                // AMap.event.addDomListener(dragMarkerMode, 'change', onModeChange);
                positionPicker.start();
                map.panBy(0, 1);

                map.addControl(new AMap.ToolBar({
                    liteStyle: true
                }))
            });
        }

        window.navigator.geolocation.getCurrentPosition(function(position) {
            jd = position.coords.longitude;
            wd = position.coords.latitude;

            url = "http://restapi.amap.com/v3/assistant/coordinate/convert?locations=" + jd + "," + wd + "&coordsys=gps&output=json&key=c962412697057591abdf0be494fc2c2b";
            $.ajax({
                type: "GET",
                url: url,
                dataType: "json",
                success: function(data) {
                    console.log(data);
                    if (data.status == "1") {
                        locat = data.locations;
                        locats = locat.split(',');
                        console.log(locat.split(','));
                        // maps(jd, wd);
                        maps(locats[0], locats[1]);
                    }
                },
                error: function(data) {
                    alert("错误了");
                    console.log(data)
                }
            });
        });
    </script>
</body>

</html>